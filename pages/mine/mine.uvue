<template>
  <view class="container">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <view class="user-section">
      <view class="user-avatar" @click="uploadAvatar">
        <image class="avatar-image" src="/static/id_image.jpg" mode="aspectFill"></image>
        <view class="avatar-upload-overlay">
          <text class="upload-icon">+</text>
        </view>
      </view>
      <view class="user-info">
        <view class="user-name-row" @click="editNickname">
          <text class="user-name">{{ userInfo.nickname }}</text>
        </view>
      </view>
    </view>

    <!-- åŸºæœ¬ä¿¡æ¯æ ‡é¢˜ -->
    <text class="app-title">{{ t('basic_info') }}</text>

    <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
    <view class="info-section">
      <view class="info-list">
        <view class="info-item" @click="editGender">
          <text class="info-icon">ğŸš»</text>
          <text class="info-label">{{ t('gender') }}</text>
          <text class="info-value gender-value">{{ userInfo.gender === 'æœªçŸ¥' ? t('unknown') : (userInfo.gender === 'ç”·' ? t('male') : t('female')) }}</text>
        </view>
        <view class="info-item" @click="editBirthday">
          <text class="info-icon">ğŸ“…</text>
          <text class="info-label">{{ t('birthday') }}</text>
          <text class="info-value">{{ userInfo.birthday }}</text>
        </view>
        <view class="info-item" @click="editAge">
          <text class="info-icon">ğŸ”¢</text>
          <text class="info-label">{{ t('age') }}</text>
          <text class="info-value">{{ userInfo.age }}</text>
        </view>
        <view class="info-item" @click="editHeight">
          <text class="info-icon">ğŸ“</text>
          <text class="info-label">{{ t('height') }}</text>
          <text class="info-value height-value">{{ userInfo.height }}{{ t('cm') }}</text>
        </view>
        <view class="info-item" @click="editWeight">
          <text class="info-icon">âš–ï¸</text>
          <text class="info-label">{{ t('weight') }}</text>
          <text class="info-value">{{ userInfo.weight }}{{ t('kg') }}</text>
        </view>
        <view class="info-item" @click="editBMI">
          <text class="info-icon">ğŸ“Š</text>
          <text class="info-label">{{ t('bmi') }}</text>
          <text class="info-value bmi-value">{{ userInfo.bmi }}</text>
        </view>
        <view class="info-item" @click="editBodyFat">
          <text class="info-icon">ğŸ“ˆ</text>
          <text class="info-label">{{ t('fat_rate') }}</text>
          <text class="info-value fat-rate-value">{{ userInfo.fatRate }}%</text>
        </view>
      </view>
    </view>
    
    <!-- è®¾ç½®é€‰é¡¹ -->
    <view class="settings-section">
      <view class="info-list">
        <view class="info-item" @click="navigateToSettings">
          <text class="info-icon">âš™ï¸</text>
          <text class="info-label">{{ t('common.settings') }}</text>
          <text class="info-value info-arrow">â€º</text>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <view class="bottom-nav">
      <view class="nav-item" @click="navigateToPage('/pages/index/index')">
        <text class="nav-icon">ğŸ“Š</text>
        <text class="nav-text">{{ t('common.home') }}</text>
      </view>
      <view class="nav-item" @click="navigateToPage('/pages/physical/physical')">
        <text class="nav-icon">ğŸ©º</text>
        <text class="nav-text">{{ t('common.health') }}</text>
      </view>
      <view class="nav-item" @click="navigateToPage('/pages/mental/mental')">
        <text class="nav-icon">ğŸ§ </text>
        <text class="nav-text">{{ t('common.mental') }}</text>
      </view>
      <view class="nav-item active" @click="navigateToPage('/pages/mine/mine')">
        <text class="nav-icon">ğŸ‘¤</text>
        <text class="nav-text">{{ t('common.mine') }}</text>
      </view>
    </view>


  </view>
</template>

<script setup>
import { ref } from 'vue'
import { t } from '@/utils/i18n/i18n.uts'

// ç”¨æˆ·ä¿¡æ¯
const userInfo = ref({
  nickname: 'yuan',
  gender: 'æœªçŸ¥',
  birthday: '2015-07-15',
  age: '20',
  height: '168.0',
  weight: '55.0',
  bmi: '20.0',
  fatRate: '0.0'
})

// å½“å‰æ—¥æœŸ
const currentDate = ref('')

// åˆå§‹åŒ–å½“å‰æ—¥æœŸ
const initDate = () => {
  const now = new Date()
  const year = now.getFullYear()
  const month = String(now.getMonth() + 1).padStart(2, '0')
  const day = String(now.getDate()).padStart(2, '0')
  currentDate.value = `${year}å¹´${month}æœˆ${day}æ—¥`
}

// ä¸Šä¼ å¤´åƒ
const uploadAvatar = () => {
  uni.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: (res) => {
      // è¿™é‡Œå¯ä»¥æ·»åŠ å›¾ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„é€»è¾‘
      // ç”±äºæ˜¯æ¨¡æ‹Ÿç¯å¢ƒï¼Œæˆ‘ä»¬ç›´æ¥æ˜¾ç¤ºé€‰æ‹©çš„å›¾ç‰‡
      const tempFilePath = res.tempFilePaths[0]
      // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨uni.uploadFileå°†å›¾ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨
      // ç„¶åå°†æœåŠ¡å™¨è¿”å›çš„å›¾ç‰‡URLä¿å­˜åˆ°userInfoä¸­
      console.log('é€‰æ‹©çš„å¤´åƒå›¾ç‰‡è·¯å¾„:', tempFilePath)
      uni.showToast({
        title: t('avatar_upload_success'),
        icon: 'success'
      })
    },
    fail: () => {
      uni.showToast({
        title: t('avatar_select_fail'),
        icon: 'none'
      })
    }
  })
}

  // ç¼–è¾‘ç”¨æˆ·å
const editNickname = () => {
  uni.showModal({
    title: t('edit_nickname'),
    editable: true,
    placeholderText: t('enter_nickname'),
    value: userInfo.value.nickname,
    success: (res) => {
      if (res.confirm && res.content) {
        userInfo.value.nickname = res.content
      }
    }
  })
}

// ç¼–è¾‘BMI
const editBMI = () => {
  uni.showModal({
    title: t('edit_bmi'),
    editable: true,
    placeholderText: t('enter_bmi'),
    value: userInfo.value.bmi,
    success: (res) => {
      if (res.confirm && res.content) {
        // éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæ•°å­—
        if (!isNaN(parseFloat(res.content))) {
          userInfo.value.bmi = parseFloat(res.content).toFixed(1)
        } else {
          uni.showToast({
        title: t('valid_number'),
        icon: 'none'
      })
        }
      }
    }
  })
}

// ç¼–è¾‘ä½“è„‚ç‡
const editBodyFat = () => {
  uni.showModal({
    title: t('edit_fat_rate'),
    editable: true,
    placeholderText: t('enter_fat_rate'),
    value: userInfo.value.fatRate,
    success: (res) => {
      if (res.confirm && res.content) {
        // éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæ•°å­—
        if (!isNaN(parseFloat(res.content))) {
          userInfo.value.fatRate = parseFloat(res.content).toFixed(1)
        } else {
          uni.showToast({
            title: $t('valid_number'),
            icon: 'none'
          })
        }
      }
    }
  })
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ—¥æœŸ
initDate()

// ç¼–è¾‘æ€§åˆ«
const editGender = () => {
  uni.showActionSheet({
    itemList: [t('male'), t('female')],
    success: (res) => {
      userInfo.value.gender = res.tapIndex === 0 ? t('male') : t('female')
    }
  })
}

// ç¼–è¾‘å¹´é¾„
const editAge = () => {
  // ç”Ÿæˆå¹´é¾„èŒƒå›´æ•°ç»„ (1-120å²)
  const ageList = []
  for (let i = 1; i <= 120; i++) {
    ageList.push(i.toString())
  }
  
  // ä½¿ç”¨é€‰æ‹©å™¨é€‰æ‹©å¹´é¾„
  uni.showActionSheet({
    itemList: ageList,
    success: (res) => {
      userInfo.value.age = ageList[res.tapIndex]
    }
  })
}

// ç¼–è¾‘ç”Ÿæ—¥
const editBirthday = () => {
  // è§£æå½“å‰æ—¥æœŸä¸ºå¹´æœˆæ—¥
  const currentDate = new Date(userInfo.value.birthday)
  let selectedYear = currentDate.getFullYear()
  let selectedMonth = currentDate.getMonth() + 1 // æœˆä»½ä»0å¼€å§‹ï¼Œéœ€è¦+1
  let selectedDay = currentDate.getDate()
  
  // ç”Ÿæˆå¹´ä»½æ•°ç»„ (1900-å½“å‰å¹´ä»½)
  const getYears = () => {
    const years = []
    const currentYearNow = new Date().getFullYear()
    for (let i = 1900; i <= currentYearNow; i++) {
      years.push(i.toString())
    }
    return years
  }
  
  // ç”Ÿæˆæœˆä»½æ•°ç»„ (1-12)
  const getMonths = () => {
    const months = []
    for (let i = 1; i <= 12; i++) {
      months.push(i.toString().padStart(2, '0'))
    }
    return months
  }
  
  // ç”Ÿæˆæ—¥æœŸæ•°ç»„ (æ ¹æ®æœˆä»½å’Œå¹´ä»½ç¡®å®šå¤©æ•°)
  const getDays = (year, month) => {
    const days = []
    const maxDays = new Date(year, month, 0).getDate()
    for (let i = 1; i <= maxDays; i++) {
      days.push(i.toString().padStart(2, '0'))
    }
    return days
  }
  
  // ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©å¹´ä»½
  const selectYear = () => {
    const years = getYears()
    uni.showActionSheet({
      title: t('select_year'),
      itemList: years,
      success: (res) => {
        selectedYear = parseInt(years[res.tapIndex])
        selectMonth() // é€‰æ‹©å®Œå¹´ä»½åé€‰æ‹©æœˆä»½
      }
    })
  }
  
  // ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æœˆä»½
  const selectMonth = () => {
    const months = getMonths()
    uni.showActionSheet({
      title: t('select_month'),
      itemList: months,
      success: (res) => {
        selectedMonth = parseInt(months[res.tapIndex])
        selectDay() // é€‰æ‹©å®Œæœˆä»½åé€‰æ‹©æ—¥æœŸ
      }
    })
  }
  
  // ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©æ—¥æœŸ
  const selectDay = () => {
    const days = getDays(selectedYear, selectedMonth)
    uni.showActionSheet({
      title: $t('select_day'),
      itemList: days,
      success: (res) => {
        selectedDay = parseInt(days[res.tapIndex])
        
        // æ ¼å¼åŒ–ä¸ºYYYY-MM-DD
        const formattedDate = `${selectedYear}-${String(selectedMonth).padStart(2, '0')}-${String(selectedDay).padStart(2, '0')}`
        userInfo.value.birthday = formattedDate
        
        // æ›´æ–°å¹´é¾„
        const today = new Date()
        const birthDate = new Date(selectedYear, selectedMonth - 1, selectedDay)
        let age = today.getFullYear() - birthDate.getFullYear()
        const monthDiff = today.getMonth() - birthDate.getMonth()
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--
        }
        userInfo.value.age = age.toString()
      }
    })
  }
  
  // å¼€å§‹é€‰æ‹©æµç¨‹
  selectYear()
}

// ç¼–è¾‘èº«é«˜
const editHeight = () => {
  uni.showModal({
    title: $t('edit_height'),
    editable: true,
    placeholderText: $t('enter_height'),
    value: userInfo.value.height,
    success: (res) => {
      if (res.confirm && res.content) {
        // éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæ•°å­—
        if (!isNaN(parseFloat(res.content))) {
          userInfo.value.height = parseFloat(res.content).toFixed(1)
        } else {
          uni.showToast({
            title: $t('valid_number'),
            icon: 'none'
          })
        }
      }
    }
  })
}

// ç¼–è¾‘ä½“é‡
const editWeight = () => {
  uni.showModal({
    title: $t('edit_weight'),
    editable: true,
    placeholderText: $t('enter_weight'),
    value: userInfo.value.weight,
    success: (res) => {
      if (res.confirm && res.content) {
        // éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºæ•°å­—
        if (!isNaN(parseFloat(res.content))) {
          userInfo.value.weight = parseFloat(res.content).toFixed(1)
        } else {
          uni.showToast({
            title: $t('valid_number'),
            icon: 'none'
          })
        }
      }
    }
  })
}



// é¡µé¢å¯¼èˆª
const navigateToPage = (url) => {
  // åˆ¤æ–­æ˜¯å¦ä¸ºtabBaré¡µé¢
  const tabBarPages = ['/pages/index/index', '/pages/physical/physical', '/pages/mental/mental', '/pages/mine/mine']
  if (tabBarPages.includes(url)) {
    uni.switchTab({
      url: url
    })
  } else {
    uni.navigateTo({
      url: url
    })
  }
}

// è·³è½¬åˆ°è®¾ç½®é¡µé¢
const navigateToSettings = () => {
  uni.navigateTo({
    url: '/pages/settings/settings'
  })
}
</script>

<style scoped>
.container {
  padding: 120rpx 30rpx 120rpx 30rpx;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  position: relative;
}

/* é¡¶éƒ¨æ ‡é¢˜æ  */
.top-bar {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  padding: 40rpx 0 30rpx 0;
  margin-bottom: 40rpx;
}

.title-left {
  font-size: 48rpx;
  font-weight: bold;
  color: $uni-text-color;
}

.title-right {
  font-size: 28rpx;
  color: $uni-text-color-grey;
}

/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
.user-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20rpx 0 60rpx 0;
  margin-bottom: 40rpx;
}

.user-avatar {
  width: 160rpx;
  height: 160rpx;
  border-radius: 50%;
  background: $uni-color-primary;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 30rpx;
  position: relative;
  cursor: pointer;
  overflow: hidden;
  box-shadow: 0 4rpx 16rpx rgba(255, 192, 203, 0.6); /* æ·»åŠ ç²‰è‰²é˜´å½±æ•ˆæœ */
}

  .avatar-upload-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.5);
    height: 30rpx;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .user-avatar:hover .avatar-upload-overlay {
    opacity: 1;
  }

  .upload-icon {
    font-size: 20rpx;
    color: #ffffff;
    font-weight: bold;
}

.avatar-icon {
  font-size: 60rpx;
}

.avatar-image {
  width: 100%;
  height: 100%;
  border-radius: 50%;
}

.user-info {
  flex: 1;
}

.user-name-row {
  display: flex;
  align-items: center;
  margin-bottom: 10rpx;
  cursor: pointer;
}

.user-name {
  font-size: 52rpx;
  font-weight: bold;
  color: $uni-text-color;
  text-align: center;
}



.subscribe-status {
  font-size: 28rpx;
  color: $uni-text-color-grey;
  display: block;
}

/* åŸºæœ¬ä¿¡æ¯åŒºåŸŸ */
.info-section {
  margin-bottom: 40rpx;
}

.app-title {
  font-size: 48rpx;
  font-weight: bold;
  color: $uni-text-color;
  display: block;
  text-align: left;
  margin-bottom: 40rpx;
}

.section-title {
  font-size: 36rpx;
  font-weight: 600;
  color: $uni-text-color;
  margin-bottom: 10rpx;
  display: block;
}

.section-subtitle {
  font-size: 26rpx;
  color: $uni-text-color-grey;
  margin-bottom: 30rpx;
  display: block;
  padding-left: 10rpx;
}

.info-list {
  background: #ffffff;
  border-radius: 16rpx;
  overflow: hidden;
  box-shadow: 0 2rpx 12rpx rgba(92, 64, 51, 0.08);
}

.info-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
  padding: 35rpx 25rpx;
  border-bottom: 1rpx solid $uni-border-color;
  transition: all 0.3s ease;
  width: 100%;
  box-sizing: border-box;
}

.info-item:last-child {
  border-bottom: none;
}

.info-item:active {
  background: $uni-bg-color-hover;
}

.info-icon {
  font-size: 36rpx;
  margin-right: 15rpx;
  flex-shrink: 0;
  width: 40rpx;
  text-align: left;
}

/* ä¼˜åŒ–ä¿¡æ¯é¡¹ç‚¹å‡»åé¦ˆ */
.info-item {
  cursor: pointer;
}

.info-label {
  font-size: 32rpx;
  color: $uni-text-color;
  flex-shrink: 0;
  width: 160rpx;
  white-space: nowrap;
}

.info-value {
  font-size: 32rpx;
  color: $uni-text-color;
  flex-shrink: 1;
  margin-left: auto;
  text-align: right;
  white-space: nowrap;
}

.info-arrow {
  font-size: 32rpx;
  color: $uni-text-color-grey;
  font-weight: bold;
}

.subscribe-status {
  font-size: 28rpx;
  color: #ff8fab;
  display: none; /* éšè—è®¢é˜…çŠ¶æ€ */
}

.gender-value {
  color: #ff8fab;
}

.height-value {
  color: #52b788;
}

.bmi-value {
  color: #f7b733;
}

.fat-rate-value {
  color: #ff8fab;
}

/* è®¾ç½®é¡¹ç‰¹æ®Šæ ·å¼ */
.settings-section .info-item {
  border-bottom: none;
}



/* åº•éƒ¨å¯¼èˆªæ  */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  flex-direction: row;
  flex-wrap: nowrap;
  justify-content: space-between;
  align-items: center;
  background-color: #ffffff;
  border-top: 1px solid #e9ecef;
  padding: 10rpx 0;
  z-index: 1000;
  width: 100%;
  box-sizing: border-box;
}

.bottom-nav .nav-item {
  width: 25%;
  box-sizing: border-box;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10rpx 0;
  color: #95a5a6;
}

.nav-item.active {
  color: #3498db;
}

.nav-icon {
  font-size: 48rpx;
  margin-bottom: 6rpx;
}

.nav-text {
  font-size: 20rpx;
}

</style>