/**
 * 历史会话管理器
 * 负责会话的本地存储和管理
 */

import { ChatSession, ChatMessage } from './api-service.uts'

class SessionManager {
  private storageKey = 'wellmate_chat_sessions'
  private currentSessionId: string | null = null
  
  // 获取所有会话
  getSessions(): ChatSession[] {
    try {
      const sessionsStr = uni.getStorageSync(this.storageKey)
      if (sessionsStr) {
        return JSON.parse(sessionsStr) as ChatSession[]
      }
    } catch (error) {
      console.error('获取会话列表失败:', error)
    }
    return []
  }
  
  // 保存会话
  saveSession(session: ChatSession): void {
    const sessions = this.getSessions()
    const index = sessions.findIndex(s => s.id === session.id)
    
    if (index >= 0) {
      sessions[index] = session
    } else {
      sessions.unshift(session) // 新会话放在最前面
    }
    
    // 限制最多保存50个会话
    if (sessions.length > 50) {
      sessions.splice(50)
    }
    
    try {
      uni.setStorageSync(this.storageKey, JSON.stringify(sessions))
    } catch (error) {
      console.error('保存会话失败:', error)
    }
  }
  
  // 创建新会话
  createNewSession(title?: string): ChatSession {
    const session: ChatSession = {
      id: this.generateSessionId(),
      title: title || '新对话',
      messages: [],
      createdAt: Date.now(),
      updatedAt: Date.now()
    }
    
    this.saveSession(session)
    this.currentSessionId = session.id
    
    return session
  }
  
  // 获取当前会话
  getCurrentSession(): ChatSession | null {
    if (!this.currentSessionId) return null
    
    const sessions = this.getSessions()
    return sessions.find(s => s.id === this.currentSessionId) || null
  }
  
  // 设置当前会话
  setCurrentSession(sessionId: string): boolean {
    const sessions = this.getSessions()
    const session = sessions.find(s => s.id === sessionId)
    
    if (session) {
      this.currentSessionId = sessionId
      return true
    }
    
    return false
  }
  
  // 添加消息到当前会话
  addMessageToCurrentSession(message: ChatMessage): boolean {
    const session = this.getCurrentSession()
    if (!session) return false
    
    session.messages.push(message)
    session.updatedAt = Date.now()
    
    // 自动生成会话标题（如果还是默认标题）
    if (session.title === '新对话' && message.role === 'user') {
      session.title = this.generateTitleFromMessage(message.content)
    }
    
    this.saveSession(session)
    return true
  }
  
  // 删除会话
  deleteSession(sessionId: string): boolean {
    const sessions = this.getSessions()
    const filteredSessions = sessions.filter(s => s.id !== sessionId)
    
    if (filteredSessions.length === sessions.length) {
      return false // 没有找到要删除的会话
    }
    
    try {
      uni.setStorageSync(this.storageKey, JSON.stringify(filteredSessions))
      
      // 如果删除的是当前会话，清空当前会话ID
      if (this.currentSessionId === sessionId) {
        this.currentSessionId = null
      }
      
      return true
    } catch (error) {
      console.error('删除会话失败:', error)
      return false
    }
  }
  
  // 清空所有会话
  clearAllSessions(): void {
    try {
      uni.setStorageSync(this.storageKey, JSON.stringify([]))
      this.currentSessionId = null
    } catch (error) {
      console.error('清空会话失败:', error)
    }
  }
  
  // 生成会话ID
  private generateSessionId(): string {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
  }
  
  // 从消息内容生成标题
  private generateTitleFromMessage(content: string): string {
    // 提取前20个字符作为标题
    const maxLength = 20
    let title = content.trim()
    
    if (title.length > maxLength) {
      title = title.substring(0, maxLength) + '...'
    }
    
    return title || '健康咨询'
  }
}

// 导出单例实例
export const sessionManager = new SessionManager()

export default sessionManager