/**
 * 历史会话管理器
 * 负责会话的本地存储和管理
 */

import { ChatSession, ChatMessage } from './api-service.uts'
import { t } from './i18n/i18n.uts'

class SessionManager {
  private storageKey = 'wellmate_chat_sessions'
  private currentSessionId: { [key in 'health' | 'mental']?: string } = {}
  
  // 获取所有会话
  getSessions(type?: 'health' | 'mental'): ChatSession[] {
    try {
      const sessionsStr = uni.getStorageSync(this.storageKey)
      if (sessionsStr) {
        const allSessions = JSON.parse(sessionsStr) as ChatSession[]
        // 如果指定了类型，只返回对应类型的会话
        if (type) {
          return allSessions.filter(session => session.type === type)
        }
        return allSessions
      }
    } catch (error) {
      console.error('获取会话列表失败:', error)
    }
    return []
  }
  
  // 保存会话
  saveSession(session: ChatSession): void {
    const sessions = this.getSessions()
    const index = sessions.findIndex(s => s.id === session.id)
    
    if (index >= 0) {
      sessions[index] = session
    } else {
      sessions.unshift(session) // 新会话放在最前面
    }
    
    // 限制最多保存50个会话
    if (sessions.length > 50) {
      sessions.splice(50)
    }
    
    try {
      uni.setStorageSync(this.storageKey, JSON.stringify(sessions))
    } catch (error) {
      console.error('保存会话失败:', error)
    }
  }
  
  // 创建新会话
  createNewSession(title?: string, type: 'health' | 'mental' = 'health'): ChatSession {
    const session: ChatSession = {
      id: this.generateSessionId(),
      title: title || t(type === 'mental' ? 'mental_new_session' : 'new_session'),
      messages: [],
      createdAt: Date.now(),
      updatedAt: Date.now(),
      type: type
    }
    
    this.saveSession(session)
    this.currentSessionId[type] = session.id
    
    return session
  }
  
  // 获取当前会话
  getCurrentSession(type: 'health' | 'mental'): ChatSession | null {
    const currentId = this.currentSessionId[type]
    if (!currentId) return null
    
    const sessions = this.getSessions()
    return sessions.find(s => s.id === currentId) || null
  }
  
  // 设置当前会话
  setCurrentSession(sessionId: string, type: 'health' | 'mental'): boolean {
    const sessions = this.getSessions(type)
    const session = sessions.find(s => s.id === sessionId)
    
    if (session) {
      this.currentSessionId[type] = sessionId
      return true
    }
    
    return false
  }
  
  // 添加消息到当前会话
  addMessageToCurrentSession(message: ChatMessage, type: 'health' | 'mental'): boolean {
    const session = this.getCurrentSession(type)
    if (!session) return false
    
    session.messages.push(message)
    session.updatedAt = Date.now()
    
    // 自动生成会话标题（如果还是默认标题）
    if ((session.title === '新对话' || session.title === 'New Message' || session.title === 'New Session') && message.role === 'user') {
      session.title = this.generateTitleFromMessage(message.content)
    }
    
    this.saveSession(session)
    return true
  }
  
  // 删除会话
  deleteSession(sessionId: string, type: 'health' | 'mental'): boolean {
    const sessions = this.getSessions()
    const sessionToDelete = sessions.find(s => s.id === sessionId)
    
    if (!sessionToDelete) {
      return false // 没有找到要删除的会话
    }
    
    const filteredSessions = sessions.filter(s => s.id !== sessionId)
    try {
      uni.setStorageSync(this.storageKey, JSON.stringify(filteredSessions))
      
      // 如果删除的是当前会话，清空对应类型的当前会话ID
      if (this.currentSessionId[type] === sessionId) {
        this.currentSessionId[type] = undefined
      }
      
      return true
    } catch (error) {
      console.error('删除会话失败:', error)
      return false
    }
  }
  
  // 清空所有会话
  clearAllSessions(type?: 'health' | 'mental'): void {
    try {
      if (type) {
        // 只清空指定类型的会话
        const sessions = this.getSessions().filter(s => s.type !== type)
        uni.setStorageSync(this.storageKey, JSON.stringify(sessions))
        // 清空对应类型的当前会话ID
        this.currentSessionId[type] = undefined
      } else {
        // 清空所有会话
        uni.setStorageSync(this.storageKey, JSON.stringify([]))
        this.currentSessionId = {}
      }
    } catch (error) {
      console.error('清空会话失败:', error)
    }
  }
  
  // 生成会话ID
  private generateSessionId(): string {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
  }
  
  // 从消息内容生成标题
  private generateTitleFromMessage(content: string): string {
    // 提取前20个字符作为标题
    const maxLength = 20
    let title = content.trim()
    
    if (title.length > maxLength) {
      title = title.substring(0, maxLength) + '...'
    }
    
    return title || '健康咨询'
  }
}

// 导出单例实例
export const sessionManager = new SessionManager()

export default sessionManager